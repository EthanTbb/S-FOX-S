#include "Stdafx.h"
#include "Resource.h"
#include "GlobalUnits.h"
#include "GameFrameApp.h"

//////////////////////////////////////////////////////////////////////////////////

BEGIN_MESSAGE_MAP(CGameFrameApp, CWinApp)
END_MESSAGE_MAP()

//////////////////////////////////////////////////////////////////////////////////

//构造函数
CGameFrameApp::CGameFrameApp()
{
	//设置变量
	m_pGameFrameWnd=NULL;
	m_pGameFrameEngine=NULL;

	//设置变量
	m_pIDispatch=NULL;
	m_pCustomOccManager=NULL;

	return;
}

//析构函数
CGameFrameApp::~CGameFrameApp()
{
}

//配置函数
BOOL CGameFrameApp::InitInstance()
{
	__super::InitInstance();

	//内部初始化
	AfxOleInit();
	AfxInitRichEdit2();
	InitCommonControls();
	AfxEnableControlContainer();

	try
	{
		//创建组件
		if (m_PlatformResourceModule.CreateInstance()==false) return false;
		m_PlatformResourceModule->LoadDefaultResource(TEXT("PlatformConfig.xml"),GetModuleHandle(GAME_FRAME_DLL_NAME));

		//变量定义
		ASSERT(CGlobalUnits::GetInstance()!=NULL);
		CGlobalUnits * pGlobalUnits=CGlobalUnits::GetInstance();

		//全局单元
		bool bSuccess=pGlobalUnits->InitGlobalUnits();
		if (bSuccess==false) throw TEXT("游戏环境初始化失败");

		//加载配置	
		m_GlobalWebLink.LoadPaltformLink();		

		//创建窗口
		m_pGameFrameWnd=GetGameFrameWnd();
		if (m_pGameFrameWnd==NULL) throw TEXT("游戏框架窗口创建失败");

		//创建引擎
		m_pGameFrameEngine=GetGameFrameEngine(VERSION_FRAME_SDK);
		if (m_pGameFrameEngine==NULL) throw TEXT("游戏引擎对象创建失败");		

		//创建对象
		m_pIDispatch=new CImpIDispatch;
		m_pCustomOccManager=new CCustomOccManager;
		AfxEnableControlContainer(m_pCustomOccManager); 

		//创建框架
		m_pMainWnd=m_pGameFrameWnd;
		m_pGameFrameWnd->Create(NULL,NULL,WS_VISIBLE|WS_CLIPCHILDREN|WS_CLIPSIBLINGS,CRect(0,0,0,0));

		//声音引擎
		m_D3DSound.CreateD3DSound(m_pMainWnd->GetSafeHwnd());

		//创建引擎
		if (m_GameFrameService.CreateGameFrameService()==false)
		{
			throw TEXT("内核引擎创建失败");
		}

		//连接广场
		IClientKernel * pIClientKernel=pGlobalUnits->m_ClientKernelModule.GetInterface();
		if ((pIClientKernel!=NULL)&&(pIClientKernel->IsSingleMode()==false)) pIClientKernel->CreateConnect();

		return TRUE;
	}
	catch (LPCTSTR pszMesssage)
	{
		//构造消息
		CString strBuffer;
		strBuffer.Format(TEXT("由于 [ %s ] 游戏程序启动失败。"),pszMesssage);

		//提示消息
		CInformation Information;
		Information.ShowMessageBox(TEXT("游戏框架"),strBuffer,MB_ICONSTOP,30L);

		//删除对象
		SafeRelease(m_pGameFrameWnd);
		SafeRelease(m_pGameFrameEngine);

		return FALSE;
	}

	return TRUE;
}

//退出函数
BOOL CGameFrameApp::ExitInstance()
{
	//视频设置
	CVideoServiceManager * pVideoServiceManager=CVideoServiceManager::GetInstance();
	if (pVideoServiceManager!=NULL) pVideoServiceManager->LogoutVideoSystem();

	//删除对象
	SafeRelease(m_pGameFrameEngine);

	//变量定义
	ASSERT(CGlobalUnits::GetInstance()!=NULL);
	CGlobalUnits * pGlobalUnits=CGlobalUnits::GetInstance();

	//关闭连接
	IClientKernel * pIClientKernel=pGlobalUnits->m_ClientKernelModule.GetInterface();
	if ((pIClientKernel!=NULL)&&(pIClientKernel->IsSingleMode()==false)) pIClientKernel->IntermitConnect();

	//注销组件
	pGlobalUnits->UnInitGlobalUnits();

	//删除对象
	SafeDelete(m_pIDispatch);
	SafeDelete(m_pCustomOccManager);

	return __super::ExitInstance();
}

//运行函数
int CGameFrameApp::Run()
{
	return __super::Run();

	ASSERT_VALID(this);
	_AFX_THREAD_STATE* pState = AfxGetThreadState();

	//变量定义
	BOOL bIdle = TRUE;
	LONG lIdleCount = 0;

	//变量定义
	ASSERT(CGlobalUnits::GetInstance()!=NULL);
	CGlobalUnits * pGlobalUnits=CGlobalUnits::GetInstance();

	//查询接口
	IGameFrameView * pIGameFrameView=(IGameFrameView *)pGlobalUnits->QueryGlobalModule(MODULE_GAME_FRAME_VIEW,IID_IGameFrameView,VER_IGameFrameView);

	//消息循环
	for (;;)
	{
		while (bIdle && !::PeekMessage(&(pState->m_msgCur), NULL, NULL, NULL, PM_NOREMOVE))
		{
			if (!OnIdle(lIdleCount++)) bIdle = FALSE;
            if (pIGameFrameView) pIGameFrameView->RenderGameView();
		}

		do
		{
			if (!PumpMessage()) return ExitInstance();

			if (IsIdleMessage(&(pState->m_msgCur)))
			{
				bIdle = TRUE;
				lIdleCount = 0;				
			}

		} while (::PeekMessage(&(pState->m_msgCur), NULL, NULL, NULL, PM_NOREMOVE));
	}
}

//创建窗口
CGameFrameWnd * CGameFrameApp::GetGameFrameWnd()
{
	return new CGameFrameWnd;
}

//////////////////////////////////////////////////////////////////////////////////
